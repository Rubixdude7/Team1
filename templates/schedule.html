{% extends "base.html" %}

{% import "psikolog/calendar.html" as calendar %}

{% block title %}Schedule an Appointment{% endblock %}

{% block head %}
{{ super() }}
{{ calendar.script_tag() }}
{% endblock %}

{% block content %}
<main id="schedule-page">
    <div class="box">
        <h2>Schedule an Appointment</h2>
        
        <select id="psyc-select">
            <option value="all" selected="selected">-- All Psychologists --</option>
        {%- for pn in psyc_names %}
            <option value="{{ pn.psyc_id }}">{{ pn.first_name }} {{ pn.last_name }}</option>
        {%- endfor %}
        </select>
        
        {{ calendar.calendar("calendar") }}


        <div id="schedule-appt">

        </div>
        
        <script type="text/javascript">
            var allAvails = {{ avails|tojson|safe }};
            
            function filterByPsyc(cal) {
                var psyc = $("#psyc-select").val();
                
                if (psyc == "all") {
                    cal.setAvailabilities(allAvails);
                    cal.refresh();
                } else {
                    psyc_id = parseInt(psyc);
                    var avails = [];
                    for (var i = 0; i < allAvails.length; i++) {
                        if (allAvails[i]["psyc_id"] == psyc_id) {
                            avails[avails.length] = allAvails[i];
                        }
                    }
                    cal.setAvailabilities(avails);
                    cal.refresh();
                }
            }
            
            $(document).ready(function() {
                var cal = new calendarModule.Calendar("#calendar");
                cal.setup();
                filterByPsyc(cal);
                
                $("#psyc-select").on("change", function() {
                    filterByPsyc(cal);
                });
                
                $("#calendar").find(".cal-day").on("click", function() {
                    var dateString = $(this).attr("data-day");
                    var weekdayString = $(this).attr("data-weekday");
                    if (dateString != undefined) {
                        var parts = dateString.split("-");
                        var year = parseInt(parts[0]);
                        var month = parseInt(parts[1]);
                        var day = parseInt(parts[2]);
                        var weekday = parseInt(weekdayString);


                        var psycs_day = [];
                        for (var i = 0; i < allAvails.length; i++) {
                            if (allAvails[i]["weekday"] == weekday) {
                                psycs_day.push(allAvails[i]);
                            }
                        }


                        /*$.ajax({
                            url : "{{ url_for('consultation') }}",
                            data: data,
                            contentType: 'application/json;charset=UTF-8',
                            type: 'POST',
                            success: function(response) {
                                alert(JSON.stringify(response));
                            },
                            error: function(error) {
                                alert(JSON.stringify(error));
                            }
                        });*/

                        var psyc = $("#psyc-select").val();
                        var psycs = {{ psyc_names|tojson|safe }};
                        var len_fee = {{ len_fee|tojson|safe }}
                        $('#schedule-appt').empty();

                        for(var i = 0; i < psycs_day.length; i++){
                            for(var j = 0; j < psycs.length; j++) {
                                if(psycs_day[i]["psyc_id"] == psycs[j]["psyc_id"] && psyc == "all"){

                                    var len_fee_str = "";
                                    for(var k = 0; k < len_fee.length; k++){
                                        len_fee_str += "<input type=\"radio\" name=\"length\" id=\"" + len_fee[k][0] + "hr\" value=\"" + len_fee[k][1] +"\" required>" +
                                                       "<label for=\"" + len_fee[k][0] + "hr\"> Length: " + len_fee[k][1] + " Fee: " + len_fee[k][2] + "</label>\""
                                    }

                                    $('#schedule-appt').append(
                                            "<br>" + psycs[j]["first_name"] + " " + psycs[j]["last_name"] +
                                            "<p>Start:</p>" + psycs_day[i]["time_st"]["hour"] + ":" + psycs_day[i]["time_st"]["minute"] +
                                            "<p>End</p>" + psycs_day[i]["time_end"]["hour"] + ":" + psycs_day[i]["time_end"]["minute"] +
                                            "<label for=\"" + psycs_day[i]["psyc_id"] + "" + psycs_day[i]["time_st"]["hour"] + "\"> Book </label>" +
                                            "<input type=\"radio\" name=\"book\" id=\"" + psycs_day[i]["psyc_id"] + "" + psycs_day[i]["time_st"]["hour"] +"\">" +
                                            "<div id=\"book-dtls\">" +
                                                "<input for=\"time-st\">Start Time</label> <input id=\"time-st\" type=\"number\" start=\"" + psycs_day[i]["time_st"]["hour"] + "\" max=\"" + psycs_day[i]["time_end"]["hour"] + "\" step=\"1\">" +
                                                len_fee_str
                                            + "</div>"

                                    );
                                }
                                else {
                                    if(psycs_day[i]["psyc_id"] == psyc && psycs[j]["psyc_id"] == psyc) $('#schedule-appt').append(
                                        "<br>" + psycs[j]["first_name"] + " " + psycs[j]["last_name"] +
                                            "<br> <p>Start:</p>" + psycs_day[i]["time_st"]["hour"] + ":" + psycs_day[i]["time_st"]["minute"] +
                                            "<p>End</p>" + psycs_day[i]["time_end"]["hour"] + ":" + psycs_day[i]["time_end"]["minute"]
                                    );
                                }
                            }
                        }

                        $('#schedule-appt').css('display', 'block');

                    }
                });
            });
        </script>
    </div>
</main>
{% endblock %}
